<!doctype html>
<html class="no-js" lang="bg" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="author" content="Hristian Iliev">
    <meta name="keywords" content="Squad,Team,Organize">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моите съобщения - SquadKnowHow</title>

    <!-- Tab-icon -->
    <link rel="apple-touch-icon" href="/static/images/apple-touch-icon.png">
    <link rel="shortcut icon" type="image/ico" href="/static/images/favicon.ico" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <!-- Icons -->
    <link rel="stylesheet" href="/static/css/themify-icons.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <script src="/static/js/vendor/modernizr-2.8.3.min.js"></script>

    <!-- Material design bootstrap -->
    <link href="/static/css/mdb.min.css" rel="stylesheet">

    <!-- Notifications -->
    <link rel="stylesheet" href="/static/css/notifications.css">

    <!-- Main-css -->
    <link rel="stylesheet" href="/static/css/normalize.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/responsive.css">

    <!-- Buttons -->
    <link rel="stylesheet" href="/static/css/buttons.css">

    <!-- Main-css -->
    <link rel="stylesheet" href="/static/css/my-messages.css">

    <!-- Popups -->
    <link rel="stylesheet" href="/static/css/jquery-confirm.min.css">
    <link rel="stylesheet" href="/static/css/iziToast.min.css">

    <!-- Modal dialog -->
    <link rel="stylesheet" href="/static/css/vex.css" />
    <link rel="stylesheet" href="/static/css/vex-theme-default.css" />
    <link rel="stylesheet" href="/static/css/call-button.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />

    <link rel="stylesheet" href="/static/css/jQuery-modal-custom-css.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.2.0/animate.min.css">

    <script src="https://cdn.rawgit.com/icons8/titanic/master/dist/js/titanic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/4.5.9/bodymovin.min.js"></script>

    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        @media(max-width: 1200px) and (min-width: 1020px) {
            .card {
                margin-left: 50px;
                margin-right: 50px;
            }
        }
        
        .ui-widget.ui-widget-content {
            z-index: 9999;
        }
    </style>

    <link rel="stylesheet" href="/static/css/footer-distributed.css">

    <link rel="stylesheet" href="/static/css/jquery-ui.min.css">

    <link rel="stylesheet" href="/static/css/sweetAlert2.css">

    <link rel="stylesheet" href="/static/css/videoCall.css">

    <style>
        .sk-wave {
            /* margin: 40px auto; */
            margin-top: auto;
            position: fixed;
            left: 50%;
            transform: translate(-50%, 0);
            z-index: 99999;
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 10px;
        }
        
        .sk-wave .sk-rect {
            margin: 0 3px 0 0;
            background-color: white;
            height: 100%;
            width: 7px;
            display: inline-block;
            -webkit-animation: sk-waveStretchDelay 1.2s infinite ease-in-out;
            animation: sk-waveStretchDelay 1.2s infinite ease-in-out;
        }
        
        .sk-wave .sk-rect1 {
            -webkit-animation-delay: -1.2s;
            animation-delay: -1.2s;
        }
        
        .sk-wave .sk-rect2 {
            -webkit-animation-delay: -1.1s;
            animation-delay: -1.1s;
        }
        
        .sk-wave .sk-rect3 {
            -webkit-animation-delay: -1s;
            animation-delay: -1s;
        }
        
        .sk-wave .sk-rect4 {
            -webkit-animation-delay: -0.9s;
            animation-delay: -0.9s;
        }
        
        .sk-wave .sk-rect5 {
            -webkit-animation-delay: -0.8s;
            animation-delay: -0.8s;
        }
        
        @-webkit-keyframes sk-waveStretchDelay {
            0%,
            40%,
            100% {
                -webkit-transform: scaleY(0.4);
                transform: scaleY(0.4);
            }
            20% {
                -webkit-transform: scaleY(1);
                transform: scaleY(1);
            }
        }
        
        @keyframes sk-waveStretchDelay {
            0%,
            40%,
            100% {
                -webkit-transform: scaleY(0.4);
                transform: scaleY(0.4);
            }
            20% {
                -webkit-transform: scaleY(1);
                transform: scaleY(1);
            }
        }
    </style>

    <link rel="stylesheet" href="/static/css/headerSignedInRegulator.css">

    <link rel="stylesheet" href="/static/css/my-messages-regulator.css">
</head>

<body th:id="'user-id_' + ${user.getId()}" data-spy="scroll" class="bg-my-messages">

    <div th:replace="fragments/preloader :: preloader"></div>

    <div class="page-wrapper">
        <div id="for-sweet">

            <div th:replace="fragments/headerSignedIn :: header('messages')">
            </div>

            <div class="phone-container">
                <div class="phonering-alo-phone phonering-alo-green phonering-alo-show" id="phonering-alo-phoneIcon"
                    style="margin-left: 0px;margin-right: 0px;">
                    <div class="phonering-alo-ph-circle"></div>
                    <div class="phonering-alo-ph-circle-fill"></div>
                    <a class="pps-btn-img" title="Гласов разговор" onclick="showDialogCall()">
                        <div class="phonering-alo-ph-img-circle"></div>
                    </a>
                </div>

                <div class="phonering-alo-phone phonering-alo-green phonering-alo-show" id="phonering-alo-videoIcon">
                    <div class="phonering-alo-ph-circle"></div>
                    <div class="phonering-alo-ph-circle-fill"></div>
                    <a class="pps-btn-img" title="Видео разговор" onclick="showDialog()">
                        <div class="phonering-alo-ph-img-circle-video"></div>
                    </a>
                </div>
            </div>

            <div class="card card-messages" style="margin-top: 0px;">
                <div class="card-body">
                    <ul class="nav nav-pills mb-3 nav-fill nav-justified" id="pills-tab" role="tablist">
                        <li class="nav-item active my-active">
                            <a class="nav-link nav-link-messages active" id="pills-home-tab" data-toggle="pill" href="#pills-home"
                                role="tab" aria-controls="pills-home" aria-selected="true">
                                <i class="fa fa-envelope"></i>
                                <span th:inline="text"> Получени съобщения ([[${user.getMessages().size()}]])</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-link-messages" id="pills-profile-tab" data-toggle="pill" href="#pills-profile"
                                role="tab" aria-controls="pills-profile" aria-selected="false">
                                <i class="fa fa-share-square"></i>
                                <span th:inline="text"> Изпратени съобщения ([[${user.getSentMessages().size()}]])</spa>
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane active animated fadeInUp" id="pills-home" role="tabpanel" aria-labelledby="#pills-home-tab">
                            <div class="row">
                                <!-- List group -->
                                <div class="list-group col-md-4" id="myList" role="tablist">
                                    <a th:each="message, iter: ${user.getMessagesReverse()}" th:id="'message_' + ${message.getId()}"
                                        th:classappend="${iter.index == iter.size - 1} ? 'active' : ''" th:href="'#message-' + ${message.getId()} + '_' + ${message.getSender().getId()}"
                                        class="list-group-item list-group-item-action" data-toggle="list" role="tab">
                                        <span class="badge badge-primary badge-pill" th:inline="text">[[${message.getTimestamp()}]]</span>
                                        <span th:inline="text">[[${iter.index + 1}]]. От:
                                            [[${message.getSender().getFirstName()}]]
                                            [[${message.getSender().getLastName()}]]</span>
                                    </a>
                                </div>

                                <!-- Tab panes -->
                                <div id="received-messages-content" class="tab-content col-md-8">
                                    <div th:each="message, iter: ${user.getMessagesReverse()}" class="tab-pane animated fadeInUp"
                                        th:classappend="${iter.index == iter.size - 1} ? 'active' : ''" th:id="'message-' + ${message.getId()} + '_' + ${message.getSender().getId()}"
                                        role="tabpanel" th:inline="text">
                                        Тема: [[${message.getTopic()}]]
                                        <hr class="divider">
                                        <div th:text="${message.getContent()}">
                                        </div>
                                        <button th:if="${message.getKind() == 'normal'}" type="button" class="delete-button-messages button button-caution button-caution-outline-2px button-pill">
                                            <i class="fa fa-minus-circle"></i> Изтрий
                                        </button>
                                        <button th:if="${message.getKind() == 'normal'}" type="button" class="trigger-modal button button-primary button-primary-outline-2px button-pill button-outline">
                                            <i class="fa fa-reply"></i> Отговори
                                        </button>
                                        <button th:if="${message.getKind() == 'requestToJoin'}" class="reject-button-messages button button-caution button-caution-outline-2px button-pill"
                                            type="button">
                                            <i class="fa fa-minus-circle"></i> Отхвърли
                                        </button>
                                        <button th:if="${message.getKind() == 'requestToJoin'}" type="button" class="button button-pill button-approve-outline-2px approve-button-messages">
                                            <i class="fa fa-reply"></i> Одобри
                                        </button>
                                        <button th:if="${message.getKind() == 'inviteToJoin'}" class="reject-invite-button button button-caution button-caution-outline-2px button-pill"
                                            type="button">
                                            <i class="fa fa-minus-circle"></i> Отхвърли
                                        </button>
                                        <button th:if="${message.getKind() == 'inviteToJoin'}" type="button" class="button button-pill button-approve-outline-2px accept-invite-button">
                                            <i class="fa fa-reply"></i> Приеми
                                        </button>
                                        <button th:if="${message.getKind() == 'rejectionMessage'}" class="delete-button-messages button button-caution button-caution-outline-2px button-pill"
                                            type="button">
                                            <i class="fa fa-minus-circle"></i> Изтрий
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-center" th:if="${user.getMessages().size() == 0}">Няма получени съобщения</h3>
                        </div>
                        <div class="tab-pane animated fadeInUp" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                            <div class="row">
                                <!-- List group -->
                                <div class="list-group col-md-4" id="myList2" role="tablist">
                                    <a th:each="message, iter: ${user.getSentMessagesReverse()}" th:classappend="${iter.index == iter.size - 1} ? 'active' : ''"
                                        th:href="'#message_' + ${message.getId()}" class="list-group-item list-group-item-action"
                                        data-toggle="list" role="tab">
                                        <span class="badge badge-primary badge-pill" th:inline="text">[[${message.getTimestamp()}]]</span>
                                        <span th:inline="text">[[${iter.index + 1}]]. До:
                                            [[${message.getRecipient().getFirstName()}]]
                                            [[${message.getRecipient().getLastName()}]]</span>
                                    </a>
                                </div>

                                <!-- Tab panes -->
                                <div id="sent-messages-content" class="tab-content col-md-8">
                                    <div th:each="message, iter: ${user.getSentMessagesReverse()}" class="tab-pane animated fadeInUp"
                                        th:classappend="${iter.index == iter.size - 1} ? 'active' : ''" th:id="'message_' + ${message.getId()}"
                                        role="tabpanel" th:inline="text">
                                        Темa: [[${message.getTopic()}]]
                                        <hr class="divider">
                                        <div th:text="${message.getContent()}">
                                        </div>
                                        <button class="delete-button-messages-sent button button-caution button-pill"
                                            type="button">
                                            <i class="fa fa-minus-circle"></i> Изтрий
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <h3 th:if="${user.getSentMessages().size() == 0}">Няма изпратени съобщения</h3>
                        </div>
                    </div>
                </div>
            </div>

            <a id="demo01" href="#animatedModal"></a>

            <div id="animatedModal">
                <div class="modal-wrapper">
                    <div id="agora_local" style="z-index: 9999; width:270px;height:171px;display: inline-block; position: absolute; bottom: 0; right: 0;margin-bottom: 10px; margin-right: 10px;"></div>
                    <div id="closebt-container" class="close-animatedModal">
                        <img id="close-the-modal" class="closebt" src="/static/img/closebt.svg">
                    </div>
                    <div id="modal-container" class="call-modal-content">
                        <div id="video" style="display: flex;justify-content: center;flex-direction: column;flex-grow: 1;">
                            <!-- <div class="call-participators-container"> -->
                            <img id="receiver" th:src="@{${user.getImage()}}" alt="">
                            <p class="receiver-name">Hristian Iliev</p>
                            <!-- </div> -->
                            <p class="call-duration">Вмомента се звъни..</p>
                        </div>
                        <div class="call-controls">
                            <div id="stop-video" class='titanic titanic-stop' style="height: 50px;display: inline-block;margin-right: 40px;"
                                title="Натисни тази икона за да сппреш камерата"></div>
                            <div id="mute-mic" class='titanic titanic-no-mic' style="height: 50px;display: inline-block;"
                                title="Натисни тази икона за да заглушиш микрофона"></div>
                            <!-- <div id="share-screen" class='titanic titanic-checkbox' style="height: 50px;display: inline-block;margin-left: 40px;"
                                title="Натисни тази икона за да споделиш екрана си"></div> -->
                            <span class="red-circle" style="display: flex; justify-content: center;margin-left: 40px">
                                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAATUSURBVHhe7ZtNiFVlHMZnFMLvD3KljsZQq1xI7mwjKuQiMHATggZtQmvXImkjI4jiJgjShTsrmFJXZa2C8gPNqXa5GQxBwlXqVOJnM/2ec5+5zL2j3HPec87cO+P/Bw/vef/3fZ/3fZ+ZOXPu1ekLgiAIgiAIgiAIgiAIgiCoi/Hx8YXoVfQm+gAdm5iY+Jr2Au0vtKPoJrqNHlu6Vm3UY857zjH0PpKXPBd6mbkBh1zOobahD9GX6Bp6Qr0W5O01vkBaU2sv83Z6Hza7GO3gLEdpr6JpYVF7hH5H36DP0EfobbSZlzehQa7X0K5E862Vrg2iTRrrOZorj2+RPB/xegvUFOrPXGpPb6DF3m5vwIbWoPfQ9+hBY9sN1Efn0SfoHUob0QueWjnyZp3X0LvoU3QRPdReJqF/H32HtOfVnjqzsI9VLL4fXULjja01v9qqHUJbUdfvSWxrEfvQj7L2pL01fyq4Fgp5H3rRU+qB9frRFhYaRs0fFa7/pdENfQ/tKg/vWbRH9roXnUb3dAbB9UM0zOUW1O/h1YH54Wwl4FrfaefQbtRb95QCcJQlPoPO8l/jdNn5DntINeD5Eqa6dwgFuc4vzRk413qdLTshZ9WZ/VJ5MNS3tr4yp1yqDDzXYv0W7RDSo85ldAPp2U+/sSVdq6bXNEZjd6K1tqkMPE/5rMMulQMjPTKIe2jA5WTY2wIHdhL9oc2WQR722kl3gZdJBp8BpLOKzS6nwYb6MbnijQ65XBimz2P+DqQH3DH5TUL/H5ofafWuInseRKupTXsORK97jMb+hPQLrAn9MfQ50rPoPC9fGOYP2U9nT/+FgsEuG/1Js8TlwjBfb8EyuBYj6GO6ei6c72GF0Vx52Etv8aY+Uo16WGGYrl8uOrN8drlcHCaP2GS/S0nIQ+Cje9d6lytH3lrDy024nITOLA/aEZeKwdztNriFSj0Qy0e4WztermyA+tDjlq22u5wfJv/gyQdcSsY+sypAgcUB+SgLl/LBhA2eeIdmucvJyEu4WzterooA9WmSMlAWG1zuDOOPetJxl0ohL+Fu7Xi5StYjgxPyoj3iUmcY/JsnbXWpFPIS7taOl6sqwG3yov3Vpc4wWM9mmrTUpVLIS7hbO16uqgCXykuZuNSZbHVwtzS2m5UBCtvl9/P4CNDYrniAfNvqA8iLLuvbOalvu8IHavfLi5fr3v49Xhu4ILksw6S+7VICbPHLi5fr3v49vvCBn4XtKvPrhJfr3v5J/W9NoC39eRseA/Yac6l2ur5/Bp/1JP3TY/ImtDg6Z68zLueGOS33pLwwp7v7Z/Ar6C9NrAK8btMM2j43zGu5J+WlJ/bPJH2A+RVq+QC0IHeZfwa9bNsZY7bvP+gF+Mon3QMDQ3hJ98AgCHoCfnyv6D7oblAUP0rM2FvAOYfziwBTcX4RYCrOLwJMxflFgKk4vwgwFecXAabi/CLAPJDTtD9/aMQ3PUBKtf2pxKyEdxsH9a6DYFr+H06WHribQVf/X0XvUA669HxDICsI47qCag9RNeFuMzzVPGeFX3q+IYh1TwtRfeHr9vDm3F8KlEKBtIeoaxPh5UHBtIWYEeEVQAFNhjiVCK8ACmpqiBFeAgpMwUV4JVBwEV4QBEEQBEEQBEEQ9BJ9ff8D34ntJUBajlQAAAAASUVORK5CYII=">
                            </span>
                        </div>
                    </div>
                </div>

                <!-- <div class="modal-content">
                </div> -->
            </div>
        </div>

        <div th:replace="fragments/footerSignedIn :: footer"></div>
    </div>

    <!-- -------------JS------------------- -->
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <script src="/static/js/vendor/bootstrap.min.js"></script>

    <!-- JQuery -->
    <script type="text/javascript" src="/static/js-mdb/jquery-3.2.1.min.js"></script>

    <!-- Material-design-bootstrap -->
    <script type="text/javascript" src="/static/js-mdb/popper.min.js"></script>
    <script type="text/javascript" src="/static/js-mdb/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js-mdb/mdb.min.js"></script>

    <!-- Popups -->
    <script type="text/javascript" src="/static/js/jquery-confirm.min.js"></script>
    <script src="/static/js/iziToast.min.js" type="text/javascript"></script>

    <!-- Modal-dialog -->
    <script src="/static/js/vex.combined.min.js"></script>
    <script>
        vex.defaultOptions.className = 'vex-theme-default'
    </script>

    <!-- Main-js -->
    <script src="/static/js/animatedModal.min.js"></script>
    <script src="/static/js/my-messages.js"></script>
    <script src="/static/js/vendor.js"></script>
    <script src="/static/js/notifications.js"></script>

    <!-- <script src="/static/js/headerSignedInRegulator.js"></script> -->

    <script src="/static/js/jquery-ui.min.js"></script>
    <script src="/static/js/easytimer.min.js"></script>
    
    <script src="https://cdn.agora.io/sdk/web/AgoraRTCSDK-2.4-latest.js"></script>
    <script>
        var indexOfUndescoreForUserId = $("body")
            .attr("id")
            .indexOf("_");
        var id = $("body")
            .attr("id")
            .substring(indexOfUndescoreForUserId + 1);
        var titanic = new Titanic({
            hover: true,
            click: true
        });
        // $(document).ready(function () {
        //     $("#demo01").animatedModal();
        // })

        var client = null;
        var audio = null;
        var localStream = null;
        var isMicMuted = false;
        var isVideoDisabled = false;
        var didReceiverPickUp = false;
        var emails = "";

        function showDialog() {
            vex.dialog.open({
                message: "Избери потребители за видео разговор:",
                input: [
                    '<input id="video-call-users" name="emails" type="text" placeholder="Потребители по email" required />'
                ].join(""),
                buttons: [
                    $.extend({}, vex.dialog.buttons.YES, {
                        text: "Продължи"
                    }),
                    $.extend({}, vex.dialog.buttons.NO, {
                        text: "Затвори"
                    })
                ],
                callback: function (data) {
                    if (!data) {
                        console.log("Cancelled");
                    } else {
                        emails = data.emails;
                        $("body").append(
                            '<div id="spinner-video-id" class="animated zoomIn" style="justify-content: center;display: flex;position: fixed;top: 0;width: 100%; height: 100%;background-color: rgb(57, 190, 185);z-index: 999999;align-items: center;"><div class="sk-wave"><div class="sk-rect sk-rect1"></div><div class="sk-rect sk-rect2"></div><div class="sk-rect sk-rect3"></div><div class="sk-rect sk-rect4"></div><div class="sk-rect sk-rect5"></div></div></div>'
                        );
                        console.log("senderId " + id);
                        $.ajax({
                            url: "/api/checkOnline?emails=" + data.emails + "&senderId=" + id +
                                "&isAudio=" + false,
                            method: "GET",
                            success: function (result) {
                                console.log(result);
                                if (result.successful || result.successful == "true") {
                                    function join() {
                                        // document.getElementById("join").disabled = true;
                                        // document.getElementById("video").disabled = true;
                                        // var channel_key = null;
                                        // console.log("Init AgoraRTC client with App ID: " + appId.value);
                                        client = AgoraRTC.createClient({
                                            mode: 'live'
                                        });
                                        client.init("f93511279880484bae87889cf18c8946",
                                            function () {
                                                console.log("AgoraRTC client initialized");
                                                client.join(null, "webtest", undefined,
                                                    function (uid) {
                                                        console.log("User " + uid +
                                                            " join channel successfully"
                                                        );
                                                        // if (true) {
                                                        // camera = videoSource.value;
                                                        // microphone = audioSource.value;
                                                        localStream = AgoraRTC.createStream({
                                                            streamID: uid,
                                                            audio: true,
                                                            video: true,
                                                            screen: false,
                                                            extensionId: "minllpmhdgpndnkomcoccfekfegnlikg"
                                                        });
                                                        //localStream = AgoraRTC.createStream({streamID: uid, audio: false, cameraId: camera, microphoneId: microphone, video: false, screen: true, extensionId: 'minllpmhdgpndnkomcoccfekfegnlikg'});
                                                        // if (document.getElementById("video").checked) {
                                                        localStream.setVideoProfile(
                                                            '720p_3');
                                                        // }
                                                        // The user has granted access to the camera and mic.
                                                        localStream.on("accessAllowed",
                                                            function () {
                                                                console.log(
                                                                    "accessAllowed"
                                                                );
                                                            });
                                                        // The user has denied access to the camera and mic.
                                                        localStream.on("accessDenied",
                                                            function () {
                                                                console.log(
                                                                    "accessDenied"
                                                                );
                                                            });
                                                        localStream.init(function () {
                                                            console.log(
                                                                "getUserMedia successfully"
                                                            );

                                                            $("#receiver").attr(
                                                                "src",
                                                                result.images[
                                                                    0]);
                                                            $(".receiver-name")
                                                                .text(result.names[
                                                                    0])

                                                            $(".red-circle").click(
                                                                function () {
                                                                    client.leave(
                                                                        function () {
                                                                            $
                                                                                (
                                                                                    "#video"
                                                                                )
                                                                                .empty();
                                                                            $
                                                                                (
                                                                                    "#video"
                                                                                )
                                                                                .append(
                                                                                    '<img id="receiver" src="/static/images/plaholder_person.png" alt=""><p class="receiver-name">Hristian Iliev</p><p class="call-duration">Вмомента се звъни..</p>'
                                                                                )
                                                                            $
                                                                                (
                                                                                    "#animatedModal"
                                                                                )
                                                                                .attr(
                                                                                    "style",
                                                                                    "position: fixed; width: 100%; height: 100%; top: 0px; left: 0px; background-color: rgb(57, 190, 185); overflow-y: auto; z-index: 9999; opacity: 1; animation-duration: 0.6s;"
                                                                                )
                                                                            $
                                                                                (
                                                                                    "agora_local"
                                                                                )
                                                                                .remove();
                                                                            audio
                                                                                .pause();
                                                                            var
                                                                                close =
                                                                                document
                                                                                .getElementById(
                                                                                    'close-the-modal'
                                                                                );
                                                                            localStream
                                                                                .close();
                                                                            audio
                                                                                =
                                                                                new Audio(
                                                                                    '/static/sounds/endCall.mp3'
                                                                                );
                                                                            audio
                                                                                .play();
                                                                            close
                                                                                .click();
                                                                            console
                                                                                .log(
                                                                                    "Leavel channel successfully"
                                                                                );
                                                                        },
                                                                        function (
                                                                            err
                                                                        ) {
                                                                            console
                                                                                .log(
                                                                                    "Leave channel failed"
                                                                                );
                                                                        }
                                                                    );
                                                                });

                                                            $("#mute-mic").click(
                                                                function () {
                                                                    if (!
                                                                        isMicMuted
                                                                    ) {
                                                                        localStream
                                                                            .disableAudio();
                                                                        isMicMuted
                                                                            =
                                                                            true;
                                                                    } else {
                                                                        localStream
                                                                            .enableAudio();
                                                                        isMicMuted
                                                                            =
                                                                            false;
                                                                    }
                                                                });

                                                            $("#stop-video").click(
                                                                function () {
                                                                    if (!
                                                                        isVideoDisabled
                                                                    ) {
                                                                        localStream
                                                                            .disableVideo();
                                                                        isVideoDisabled
                                                                            =
                                                                            true;
                                                                    } else {
                                                                        localStream
                                                                            .enableVideo()
                                                                            ();
                                                                        isVideoDisabled
                                                                            =
                                                                            false;
                                                                    }
                                                                });

                                                            $(
                                                                "#spinner-video-id"
                                                            ).remove();

                                                            setTimeout(
                                                                destroyIfTimeout,
                                                                60000)

                                                            var link = document
                                                                .getElementById(
                                                                    'demo01');
                                                            link.click();

                                                            audio = new Audio(
                                                                '/static/sounds/calling.mp3'
                                                            );
                                                            audio.play();

                                                            localStream.play(
                                                                'agora_local'
                                                            );
                                                            client.publish(
                                                                localStream,
                                                                function (
                                                                    err) {
                                                                    console
                                                                        .log(
                                                                            "Publish local stream error: " +
                                                                            err
                                                                        );
                                                                });
                                                            client.on(
                                                                'stream-published',
                                                                function (
                                                                    evt) {
                                                                    console
                                                                        .log(
                                                                            "Publish local stream successfully"
                                                                        );
                                                                });
                                                        }, function (err) {
                                                            console.log(
                                                                "getUserMedia failed",
                                                                err);
                                                        });
                                                        // }
                                                    },
                                                    function (err) {
                                                        console.log(
                                                            "Join channel failed",
                                                            err);
                                                    });
                                            },
                                            function (err) {
                                                console.log("AgoraRTC client init failed",
                                                    err);
                                            });
                                        // channelKey = "";
                                        client.on('error', function (err) {
                                            console.log("Got error msg:", err.reason);
                                            if (err.reason === 'DYNAMIC_KEY_TIMEOUT') {
                                                client.renewChannelKey(null, function () {
                                                    console.log(
                                                        "Renew channel key successfully"
                                                    );
                                                }, function (err) {
                                                    console.log(
                                                        "Renew channel key failed: ",
                                                        err);
                                                });
                                            }
                                        });
                                        client.on('stream-added', function (evt) {
                                            var stream = evt.stream;
                                            console.log("New stream added: " + stream.getId());
                                            console.log("Subscribe ", stream);
                                            client.subscribe(stream, function (err) {
                                                console.log(
                                                    "Subscribe stream failed",
                                                    err);
                                            });
                                        });
                                        client.on('stream-subscribed', function (evt) {
                                            didReceiverPickUp = true;
                                            var stream = evt.stream;
                                            console.log(
                                                "Subscribe remote stream successfully: " +
                                                stream.getId());
                                            if ($('#video #agora_remote' + stream.getId())
                                                .length === 0) {
                                                $("#video").empty();
                                                var height = 0.9 * $("#video").height();
                                                $('#video').append(
                                                    '<div id="agora_remote' +
                                                    stream.getId() +
                                                    '" style="float:left; width:100%;height:' +
                                                    height +
                                                    'px;display:inline-block;"></div>'
                                                );
                                                $("#animatedModal").attr("style",
                                                    "position: fixed; width: 100%; height: 100%; top: 0px; left: 0px; background-color: black; overflow-y: auto; z-index: 9999; opacity: 1; animation-duration: 0.6s;"
                                                )
                                            }
                                            audio.pause();
                                            stream.play('agora_remote' + stream.getId());
                                            var timer = new Timer();
                                            timer.start();
                                            timer.addEventListener('secondsUpdated',
                                                function (e) {
                                                    $('.call-duration').html(timer.getTimeValues()
                                                        .toString());
                                                });

                                        });
                                        client.on('stream-removed', function (evt) {
                                            var stream = evt.stream;
                                            stream.stop();
                                            $('#agora_remote' + stream.getId()).remove();

                                            console.log("Remote stream is removed " +
                                                stream.getId());
                                        });
                                        client.on('peer-leave', function (evt) {
                                            var stream = evt.stream;
                                            if (stream) {
                                                stream.stop();
                                                stream.close();
                                                localStream.close();
                                                client.leave(
                                                    function () {
                                                        audio.pause();
                                                        $("#video").empty();
                                                        $("#video").append(
                                                            '<img id="receiver" src="/static/images/plaholder_person.png" alt=""><p class="receiver-name">Hristian Iliev</p><p class="call-duration">Вмомента се звъни..</p>'
                                                        )
                                                        $("#animatedModal").attr(
                                                            "style",
                                                            "position: fixed; width: 100%; height: 100%; top: 0px; left: 0px; background-color: rgb(57, 190, 185); overflow-y: auto; z-index: 9999; opacity: 1; animation-duration: 0.6s;"
                                                        )
                                                        var close = document.getElementById(
                                                            "close-the-modal");
                                                        $("agora_local").remove();
                                                        audio = new Audio(
                                                            '/static/sounds/endCall.mp3'
                                                        );
                                                        audio.play();
                                                        close.click();
                                                        console.log(
                                                            "Leavel channel successfully"
                                                        );
                                                    },
                                                    function (err) {
                                                        console.log(
                                                            "Leave channel failed"
                                                        );
                                                    }
                                                );
                                                $('#agora_remote' + stream.getId()).remove();
                                                console.log(evt.uid +
                                                    " leaved from this channel");
                                            }
                                        });
                                    }

                                    join();
                                } else {
                                    $("#spinner-video-id").remove();
                                    iziToast.warning({
                                        title: "Грешка",
                                        message: "Някой/и от потребители, които избрахте не са налични",
                                        position: "topRight"
                                    });
                                }
                            }
                        });
                    }
                }
            });

            function destroyIfTimeout() {
                if (!didReceiverPickUp) {
                    $.ajax({
                        url: "/api/noMoreCalling?emails=" + emails + "&id=" + id,
                        method: "GET",
                        success: function (result) {
                            audio = new Audio('/static/sounds/endCall.mp3');
                            audio.play();
                            $(".red-circle").trigger("click");
                        }
                    })
                }
            }

            function split(val) {
                return val.split(/,\s*/);
            }

            function extractLast(term) {
                return split(term).pop();
            }

            $("#video-call-users")
                .on("keydown", function (event) {
                    if (
                        event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active
                    ) {
                        event.preventDefault();
                    }
                })
                .autocomplete({
                    source: function (request, response) {
                        $.getJSON(
                            "/api/getEmails", {
                                term: extractLast(request.term)
                            },
                            response
                        );
                    },
                    search: function () {
                        // custom minLength
                        var term = extractLast(this.value);
                        if (term.length < 2) {
                            return false;
                        }
                    },
                    focus: function () {
                        // prevent value inserted on focus
                        return false;
                    },
                    select: function (event, ui) {
                        var terms = split(this.value);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push("");
                        this.value = terms.join(", ");

                        return false;
                    },
                    autoFocus: true
                });
        }

        function showDialogCall() {
            vex.dialog.open({
                message: "Избери потребители за разговор:",
                input: [
                    '<input id="video-call-users" name="emails" type="text" placeholder="Потребители по email" required />'
                ].join(""),
                buttons: [
                    $.extend({}, vex.dialog.buttons.YES, {
                        text: "Продължи"
                    }),
                    $.extend({}, vex.dialog.buttons.NO, {
                        text: "Затвори"
                    })
                ],
                callback: function (data) {
                    if (!data) {
                        console.log("Cancelled");
                    } else {
                        emails = data.emails;
                        $("body").append(
                            '<div id="spinner-video-id" class="animated zoomIn" style="justify-content: center;display: flex;position: fixed;top: 0;width: 100%; height: 100%;background-color: rgb(57, 190, 185);z-index: 999999;align-items: center;"><div class="sk-wave"><div class="sk-rect sk-rect1"></div><div class="sk-rect sk-rect2"></div><div class="sk-rect sk-rect3"></div><div class="sk-rect sk-rect4"></div><div class="sk-rect sk-rect5"></div></div></div>'
                        );
                        console.log("senderId " + id);
                        $.ajax({
                            url: "/api/checkOnline?emails=" + data.emails + "&senderId=" + id +
                                "&isAudio=" + true,
                            method: "GET",
                            success: function (result) {
                                console.log(result);
                                if (result.successful || result.successful == "true") {
                                    function join() {
                                        // document.getElementById("join").disabled = true;
                                        // document.getElementById("video").disabled = true;
                                        // var channel_key = null;
                                        // console.log("Init AgoraRTC client with App ID: " + appId.value);
                                        client = AgoraRTC.createClient({
                                            mode: 'live',
                                            codec: "h264"
                                        });

                                        client.init("f93511279880484bae87889cf18c8946",
                                            function () {
                                                console.log("AgoraRTC client initialized");
                                                client.join(null, "webtest", undefined,
                                                    function (uid) {
                                                        console.log("User " + uid +
                                                            " join channel successfully"
                                                        );
                                                        localStream = AgoraRTC.createStream({
                                                            streamID: uid,
                                                            audio: true,
                                                            video: false,
                                                            screen: false,
                                                            extensionId: "minllpmhdgpndnkomcoccfekfegnlikg"
                                                        });

                                                        // The user has granted access to the camera and mic.
                                                        localStream.on("accessAllowed",
                                                            function () {
                                                                console.log(
                                                                    "accessAllowed"
                                                                );
                                                            });
                                                        // The user has denied access to the camera and mic.
                                                        localStream.on("accessDenied",
                                                            function () {
                                                                console.log(
                                                                    "accessDenied"
                                                                );
                                                            });
                                                        localStream.init(function () {
                                                            console.log(
                                                                "getUserMedia successfully"
                                                            );

                                                            $("#video").html('');

                                                            for (var i = 0; i <
                                                                result.images.length; i +=
                                                                1) {
                                                                console.log(
                                                                    "adding new user"
                                                                );

                                                                $("#video").append(
                                                                    '<div class="call-participators-container"><img src="' +
                                                                    result.images[
                                                                        i] +
                                                                    '" class="receiver-class" alt=""><p class="receiver-name">' +
                                                                    result.names[
                                                                        i] +
                                                                    '</p></div>'
                                                                )
                                                            }

                                                            $(
                                                                ".call-participators-container"
                                                            ).wrapAll(
                                                                '<div style="display: flex; justify-content: center; flex-direction:row; align-items:center;"></div>'
                                                            )


                                                            $("#video").append(
                                                                '<p class="call-duration">Вмомента се звъни..</p>'
                                                            );

                                                            // $("#receiver").attr(
                                                            //     "src",
                                                            //     result.images[
                                                            //         0]);
                                                            // $(".receiver-name")
                                                            //     .text(result.names[
                                                            //         0]);

                                                            $(".red-circle").click(
                                                                function () {
                                                                    client.leave(
                                                                        function () {
                                                                            $
                                                                                (
                                                                                    "#video"
                                                                                )
                                                                                .empty();
                                                                            $
                                                                                (
                                                                                    "#video"
                                                                                )
                                                                                .append(
                                                                                    '<img id="receiver" src="/static/images/plaholder_person.png" alt=""><p class="receiver-name">Hristian Iliev</p><p class="call-duration">Вмомента се звъни..</p>'
                                                                                )
                                                                            $
                                                                                (
                                                                                    "#animatedModal"
                                                                                )
                                                                                .attr(
                                                                                    "style",
                                                                                    "position: fixed; width: 100%; height: 100%; top: 0px; left: 0px; background-color: rgb(57, 190, 185); overflow-y: auto; z-index: 9999; opacity: 1; animation-duration: 0.6s;"
                                                                                )
                                                                            audio
                                                                                .pause();
                                                                            var
                                                                                close =
                                                                                document
                                                                                .getElementById(
                                                                                    'close-the-modal'
                                                                                );
                                                                            localStream
                                                                                .close();
                                                                            audio
                                                                                =
                                                                                new Audio(
                                                                                    '/static/sounds/endCall.mp3'
                                                                                );
                                                                            audio
                                                                                .play();
                                                                            close
                                                                                .click();
                                                                            console
                                                                                .log(
                                                                                    "Leavel channel successfully"
                                                                                );
                                                                        },
                                                                        function (
                                                                            err
                                                                        ) {
                                                                            console
                                                                                .log(
                                                                                    "Leave channel failed"
                                                                                );
                                                                        }
                                                                    );
                                                                });

                                                            $("#mute-mic").click(
                                                                function () {
                                                                    if (!
                                                                        isMicMuted
                                                                    ) {
                                                                        localStream
                                                                            .disableAudio();
                                                                        isMicMuted
                                                                            =
                                                                            true;
                                                                    } else {
                                                                        localStream
                                                                            .enableAudio();
                                                                        isMicMuted
                                                                            =
                                                                            false;
                                                                    }
                                                                });

                                                            $(
                                                                "#spinner-video-id"
                                                            ).remove();

                                                            $("#stop-video").remove();
                                                            // $("#share-screen").remove();

                                                            setTimeout(
                                                                destroyIfTimeout,
                                                                60000)

                                                            var link = document
                                                                .getElementById(
                                                                    'demo01');
                                                            link.click();

                                                            audio = new Audio(
                                                                '/static/sounds/calling.mp3'
                                                            );
                                                            audio.play();

                                                            localStream.play(
                                                                'agora_local'
                                                            );
                                                            client.publish(
                                                                localStream,
                                                                function (
                                                                    err) {
                                                                    console
                                                                        .log(
                                                                            "Publish local stream error: " +
                                                                            err
                                                                        );
                                                                });
                                                            client.on(
                                                                'stream-published',
                                                                function (
                                                                    evt) {
                                                                    console
                                                                        .log(
                                                                            "Publish local stream successfully"
                                                                        );
                                                                });
                                                        }, function (err) {
                                                            console.log(
                                                                "getUserMedia failed",
                                                                err);
                                                        });
                                                        // }
                                                    },
                                                    function (err) {
                                                        console.log(
                                                            "Join channel failed",
                                                            err);
                                                    });
                                            },
                                            function (err) {
                                                console.log("AgoraRTC client init failed",
                                                    err);
                                            });
                                        // channelKey = "";
                                        client.on('error', function (err) {
                                            console.log("Got error msg:", err.reason);
                                            if (err.reason === 'DYNAMIC_KEY_TIMEOUT') {
                                                client.renewChannelKey(null, function () {
                                                    console.log(
                                                        "Renew channel key successfully"
                                                    );
                                                }, function (err) {
                                                    console.log(
                                                        "Renew channel key failed: ",
                                                        err);
                                                });
                                            }
                                        });
                                        client.on('stream-added', function (evt) {
                                            var stream = evt.stream;
                                            console.log("New stream added: " + stream.getId());
                                            console.log("Subscribe ", stream);
                                            client.subscribe(stream, function (err) {
                                                console.log(
                                                    "Subscribe stream failed",
                                                    err);
                                            });
                                        });
                                        client.on('stream-subscribed', function (evt) {
                                            didReceiverPickUp = true;
                                            var stream = evt.stream;
                                            console.log(
                                                "Subscribe remote stream successfully: " +
                                                stream.getId());
                                            if ($('#video #agora_remote' + stream.getId())
                                                .length === 0) {
                                                $('#video').append(
                                                    '<div id="agora_remote' +
                                                    stream.getId() +
                                                    '" style="display:inline-block;"></div>'
                                                );
                                            }

                                            audio.pause();
                                            stream.play('agora_remote' + stream.getId());
                                            var timer = new Timer();
                                            timer.start();
                                            timer.addEventListener('secondsUpdated',
                                                function (e) {
                                                    $('.call-duration').html(timer.getTimeValues()
                                                        .toString());
                                                });

                                        });
                                        client.on('stream-removed', function (evt) {
                                            var stream = evt.stream;
                                            stream.stop();
                                            $('#agora_remote' + stream.getId()).remove();

                                            console.log("Remote stream is removed " +
                                                stream.getId());
                                        });
                                        client.on('peer-leave', function (evt) {
                                            var stream = evt.stream;
                                            if (stream) {
                                                stream.stop();
                                                stream.close();
                                                localStream.close();
                                                client.leave(
                                                    function () {
                                                        audio.pause();
                                                        $("#video").empty();
                                                        $("#video").append(
                                                            '<img id="receiver" src="/static/images/plaholder_person.png" alt=""><p class="receiver-name">Hristian Iliev</p><p class="call-duration">Вмомента се звъни..</p>'
                                                        )
                                                        $("#animatedModal").attr(
                                                            "style",
                                                            "position: fixed; width: 100%; height: 100%; top: 0px; left: 0px; background-color: rgb(57, 190, 185); overflow-y: auto; z-index: 9999; opacity: 1; animation-duration: 0.6s;"
                                                        )
                                                        var close = document.getElementById(
                                                            "close-the-modal");
                                                        $("agora_local").remove();
                                                        audio = new Audio(
                                                            '/static/sounds/endCall.mp3'
                                                        );
                                                        audio.play();
                                                        close.click();
                                                        console.log(
                                                            "Leavel channel successfully"
                                                        );
                                                    },
                                                    function (err) {
                                                        console.log(
                                                            "Leave channel failed"
                                                        );
                                                    }
                                                );
                                                $('#agora_remote' + stream.getId()).remove();
                                                console.log(evt.uid +
                                                    " leaved from this channel");
                                            }
                                        });
                                    }

                                    join();
                                } else {
                                    $("#spinner-video-id").remove();
                                    iziToast.warning({
                                        title: "Грешка",
                                        message: "Някой/и от потребители, които избрахте не са налични",
                                        position: "topRight"
                                    });
                                }
                            }
                        });
                    }
                }
            });

            function destroyIfTimeout() {
                if (!didReceiverPickUp) {
                    $.ajax({
                        url: "/api/noMoreCalling?emails=" + emails + "&id=" + id,
                        method: "GET",
                        success: function (result) {
                            audio = new Audio('/static/sounds/endCall.mp3');
                            audio.play();
                            $(".red-circle").trigger("click");
                        }
                    })
                }
            }

            function split(val) {
                return val.split(/,\s*/);
            }

            function extractLast(term) {
                return split(term).pop();
            }

            $("#video-call-users")
                .on("keydown", function (event) {
                    if (
                        event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active
                    ) {
                        event.preventDefault();
                    }
                })
                .autocomplete({
                    source: function (request, response) {
                        $.getJSON(
                            "/api/getEmails", {
                                term: extractLast(request.term)
                            },
                            response
                        );
                    },
                    search: function () {
                        // custom minLength
                        var term = extractLast(this.value);
                        if (term.length < 2) {
                            return false;
                        }
                    },
                    focus: function () {
                        // prevent value inserted on focus
                        return false;
                    },
                    select: function (event, ui) {
                        var terms = split(this.value);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push("");
                        this.value = terms.join(", ");

                        return false;
                    },
                    autoFocus: true
                });
        }
    </script>

    <script src="/static/js/sweetAlert2.all.min.js"></script>
    <script src="/static/js/callChecker.js"></script>
    <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
</body>

</html>